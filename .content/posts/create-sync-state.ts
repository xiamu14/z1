export default {
  "filePath": "/Users/ben/Documents/workspace/project/z1/posts/create-sync-state.md",
  "content": "<h2>React 的 createSyncState</h2>\n<p>源码如下:</p>\n<pre class=\"shiki shiki-themes min-light min-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#1f1f1f;color:#24292eff;--shiki-dark:#b392f0\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">import</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> { useSyncExternalStore } </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">from</span><span style=\"color:#22863A;--shiki-dark:#FFAB70\"> 'react'</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#C2C3C5;--shiki-dark:#6B737C\">// -------------------- 自动 batch --------------------</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">const</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> pending</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\"> =</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\"> new</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Set</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">&#x3C;</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">State</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">&#x3C;</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">any</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">>>();</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">let</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> scheduled </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> false</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">function</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> scheduleFlush</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">() {</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">  if</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> (</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">!</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">scheduled) {</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">    scheduled </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> true</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">;</span></span>\n<span class=\"line\"><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">    Promise</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.resolve</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">()</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.then</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(() </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=></span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> {</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">      const</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> states</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\"> =</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> Array</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.from</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(pending);</span></span>\n<span class=\"line\"><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">      pending</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.clear</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">();</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">      scheduled </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> false</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">;</span></span>\n<span class=\"line\"><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">      states</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.forEach</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">((s) </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=></span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> s</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.flush</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">());</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">    });</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">  }</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#C2C3C5;--shiki-dark:#6B737C\">// -------------------- State 类 --------------------</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">class</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> State</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">&#x3C;</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">T</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">> {</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">  private</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> _value</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> T</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">;</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">  private</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> listeners </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\"> new</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Set</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">&#x3C;() </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=></span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> void</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">>();</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">  _refCount </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=</span><span style=\"color:#1976D2;--shiki-dark:#F8F8F8\"> 0</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">;</span></span>\n<span class=\"line\"><span style=\"color:#C2C3C5;--shiki-dark:#6B737C\">  // private dirty = false;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">  constructor</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(initial</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> T</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">) {</span></span>\n<span class=\"line\"><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">    this</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">._value </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> initial;</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">  get</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> value</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">()</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> T</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> {</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">    return</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> this</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">._value;</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">  set</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> value</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(next</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> T</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\"> |</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> ((prev</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> T</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">) </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=></span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> T</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">)) {</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">    const</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> newValue</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\"> =</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">      typeof</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> next </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">===</span><span style=\"color:#22863A;--shiki-dark:#FFAB70\"> 'function'</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\"> ?</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> (next </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">as</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> (prev</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> T</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">) </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=></span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> T</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">)(</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">this</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">._value) </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">:</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> next;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">    if</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> (</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">Object</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.is</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(newValue</span><span style=\"color:#212121;--shiki-dark:#BBBBBB\">,</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> this</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">._value)) </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">return</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">;</span></span>\n<span class=\"line\"><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">    this</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">._value </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> newValue;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#C2C3C5;--shiki-dark:#6B737C\">    // 自动 batch: 收集待更新 state</span></span>\n<span class=\"line\"><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">    pending</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.add</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">this</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">);</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">    scheduleFlush</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">();</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">  subscribe</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">cb</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">:</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> () </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=></span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> void</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">) {</span></span>\n<span class=\"line\"><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">    this</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">listeners</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.add</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(cb);</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">    return</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> () </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=></span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> this</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">listeners</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.delete</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(cb);</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">  flush</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">() {</span></span>\n<span class=\"line\"><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">    this</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">listeners</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.forEach</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">((l) </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=></span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> l</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">());</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">  hasSubscribers</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">() {</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">    return</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> this</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">.</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">listeners</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">.size </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">></span><span style=\"color:#1976D2;--shiki-dark:#F8F8F8\"> 0</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">;</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">  }</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#C2C3C5;--shiki-dark:#6B737C\">// -------------------- Scoped State 管理 --------------------</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">const</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> scopes</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\"> =</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\"> new</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Map</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">&#x3C;</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">symbol</span><span style=\"color:#212121;--shiki-dark:#BBBBBB\">,</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> State</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">&#x3C;</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">any</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">>>();</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#C2C3C5;--shiki-dark:#6B737C\">// -------------------- createSyncState --------------------</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">export</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\"> function</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> createSyncState</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">&#x3C;</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">T</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">>(initial</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> T</span><span style=\"color:#212121;--shiki-dark:#BBBBBB\">,</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> key</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">?:</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> symbol</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">) {</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">  const</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> stateKey</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\"> =</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> key </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">??</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> Symbol</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(</span><span style=\"color:#22863A;--shiki-dark:#FFAB70\">'global'</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">);</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">  let</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> state </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> scopes</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.get</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(stateKey) </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">as</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> State</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">&#x3C;</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">T</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">>;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">  if</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> (</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">!</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">state) {</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">    state </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\"> new</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> State</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(initial);</span></span>\n<span class=\"line\"><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">    scopes</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.set</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(stateKey</span><span style=\"color:#212121;--shiki-dark:#BBBBBB\">,</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> state);</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">  return</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\"> new</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> (</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">class</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> {</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">    _state </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> state;</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">    get</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> value</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">() {</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">      return</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> state</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">!</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">.value;</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">    }</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">    set</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> value</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(v</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> T</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">) {</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">      state</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">!</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">.value </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> v;</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">    }</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">  })();</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#C2C3C5;--shiki-dark:#6B737C\">// -------------------- useSyncState --------------------</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">export</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\"> function</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> useSyncState</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">&#x3C;</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">T</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">>(stateObj</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">:</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> { _state</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">:</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> State</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">&#x3C;</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">T</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">> }) {</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">  const</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> state</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\"> =</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> stateObj</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">._state;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">  return</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> useSyncExternalStore</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">    (listener) </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=></span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> {</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">      const</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> unsubscribe</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\"> =</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> state</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.subscribe</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(listener);</span></span>\n<span class=\"line\"><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">      state</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">._refCount</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">++</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">      return</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> () </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=></span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">        unsubscribe</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">();</span></span>\n<span class=\"line\"><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">        state</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">._refCount</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">--</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">;</span></span>\n<span class=\"line\"><span style=\"color:#C2C3C5;--shiki-dark:#6B737C\">        // 自动清理私域状态（非全局 key）</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">        if</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> (</span></span>\n<span class=\"line\"><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">          state</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">._refCount </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">===</span><span style=\"color:#1976D2;--shiki-dark:#F8F8F8\"> 0</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\"> &#x26;&#x26;</span></span>\n<span class=\"line\"><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">          Object</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.getOwnPropertySymbols</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(stateObj)[</span><span style=\"color:#1976D2;--shiki-dark:#F8F8F8\">0</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">]</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">        ) {</span></span>\n<span class=\"line\"><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">          scopes</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.forEach</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">((s</span><span style=\"color:#212121;--shiki-dark:#BBBBBB\">,</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> k) </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=></span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> {</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">            if</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> (s </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">===</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> state) </span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">scopes</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.delete</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(k);</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">          });</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">        }</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">      };</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">    }</span><span style=\"color:#212121;--shiki-dark:#BBBBBB\">,</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">    () </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=></span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> state</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">.value</span><span style=\"color:#212121;--shiki-dark:#BBBBBB\">,</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">    () </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=></span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> state</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">.value</span><span style=\"color:#212121;--shiki-dark:#BBBBBB\">,</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">  );</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">}</span></span></code></pre>\n<p>使用示例：</p>\n<pre class=\"shiki shiki-themes min-light min-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#1f1f1f;color:#24292eff;--shiki-dark:#b392f0\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">const</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> globalCounter</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\"> =</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> createSyncState</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(</span><span style=\"color:#1976D2;--shiki-dark:#F8F8F8\">0</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">);</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">function</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> App</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">() {</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">  const</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\"> count</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\"> =</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\"> useSyncState</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(globalCounter);</span></span>\n<span class=\"line\"><span style=\"color:#D32F2F;--shiki-dark:#F97583\">  return</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> (</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">    &#x3C;</span><span style=\"color:#22863A;--shiki-dark:#FFAB70\">div</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">></span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">      &#x3C;</span><span style=\"color:#22863A;--shiki-dark:#FFAB70\">p</span></span>\n<span class=\"line\"><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">        onClick</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">{() </span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">=></span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\"> {</span></span>\n<span class=\"line\"><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">          globalCounter</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">.value</span><span style=\"color:#D32F2F;--shiki-dark:#F97583\">++</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">;</span></span>\n<span class=\"line\"><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">          console</span><span style=\"color:#6F42C1;--shiki-dark:#B392F0\">.log</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">(</span><span style=\"color:#1976D2;--shiki-dark:#79B8FF\">globalCounter</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">.value); </span><span style=\"color:#C2C3C5;--shiki-dark:#6B737C\">// 1</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">        }}</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">      ></span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">        {count}</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">      &#x3C;/</span><span style=\"color:#22863A;--shiki-dark:#FFAB70\">p</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">></span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">    &#x3C;/</span><span style=\"color:#22863A;--shiki-dark:#FFAB70\">div</span><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">></span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">  );</span></span>\n<span class=\"line\"><span style=\"color:#24292EFF;--shiki-dark:#B392F0\">}</span></span></code></pre>",
  "fileName": "create-sync-state",
  "subject": [],
  "md5": "1d6c25dc530591c8b1e0111cb691c179",
  "id": "Ymd7vD",
  "frontMatter": {
    "title": "React 的 createSyncState",
    "description": "使用 createSyncState 和 useSyncState 获得同步最新状态",
    "cover": "https://images.unsplash.com/photo-1488590528505-98d2b5aba04b?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
  },
  "updateAt": 1755959142233
}